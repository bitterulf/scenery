<html>
    <head>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.5.1/pixi.min.js"></script>
    </head>
    <body>
        <script>
            const EasingFunctions = {
                // no easing, no acceleration
                linear: function (t) { return t },
                // accelerating from zero velocity
                easeInQuad: function (t) { return t*t },
                // decelerating to zero velocity
                easeOutQuad: function (t) { return t*(2-t) },
                // acceleration until halfway, then deceleration
                easeInOutQuad: function (t) { return t<.5 ? 2*t*t : -1+(4-2*t)*t },
                // accelerating from zero velocity
                easeInCubic: function (t) { return t*t*t },
                // decelerating to zero velocity
                easeOutCubic: function (t) { return (--t)*t*t+1 },
                // acceleration until halfway, then deceleration
                easeInOutCubic: function (t) { return t<.5 ? 4*t*t*t : (t-1)*(2*t-2)*(2*t-2)+1 },
                // accelerating from zero velocity
                easeInQuart: function (t) { return t*t*t*t },
                // decelerating to zero velocity
                easeOutQuart: function (t) { return 1-(--t)*t*t*t },
                // acceleration until halfway, then deceleration
                easeInOutQuart: function (t) { return t<.5 ? 8*t*t*t*t : 1-8*(--t)*t*t*t },
                // accelerating from zero velocity
                easeInQuint: function (t) { return t*t*t*t*t },
                // decelerating to zero velocity
                easeOutQuint: function (t) { return 1+(--t)*t*t*t*t },
                // acceleration until halfway, then deceleration
                easeInOutQuint: function (t) { return t<.5 ? 16*t*t*t*t*t : 1+16*(--t)*t*t*t*t }
            };

            const getInterpolationIndexes = function(keyframes, key) {
                let firstIndex = 0;
                keyframes.forEach(function(keyframe, index) {
                    if (keyframe.key <= key) {
                        firstIndex = index;
                    }
                });

                if (firstIndex == keyframes.length - 1) {
                    return [firstIndex, firstIndex];
                }
                else {
                    return [firstIndex, firstIndex + 1];
                }
            };

            const getInterpolationState = function(keyframes, key) {
                const indexes = getInterpolationIndexes(keyframes, key);
                const startFrame = keyframes[indexes[0]];
                const goalFrame = keyframes[indexes[1]];
                const totalTime = goalFrame.key - startFrame.key;
                if (totalTime == 0) {
                    return {
                        x: startFrame.x,
                        y: startFrame.y,
                        color: startFrame.color,
                        alpha: startFrame.alpha
                    }
                }

                const currentTime = key - startFrame.key;
                const percent = currentTime / totalTime;

                const factor = EasingFunctions.easeInOutQuint(percent);

                const color = [
                    (goalFrame.color[0] - startFrame.color[0]) * factor + startFrame.color[0],
                    (goalFrame.color[1] - startFrame.color[1]) * factor + startFrame.color[1],
                    (goalFrame.color[2] - startFrame.color[2]) * factor + startFrame.color[2]
                ];

                return {
                    x: (goalFrame.x - startFrame.x) * factor + startFrame.x,
                    y: (goalFrame.y - startFrame.y) * factor + startFrame.y,
                    color: color,
                    alpha: (goalFrame.alpha - startFrame.alpha) * factor + startFrame.alpha,
                }
            }

            const timelineSprite = function(sprite, keyframes) {
                this.sprite = sprite;
                this.keyframes = keyframes;
            };

            timelineSprite.prototype.updateTime = function(time) {
                const state = getInterpolationState(this.keyframes, time);

                this.sprite.x = state.x;
                this.sprite.y = state.y;
                this.sprite.tint = PIXI.utils.rgb2hex(state.color);
                this.sprite.alpha = state.alpha;
            };

            const createActions = function() {
                const actions = [];

                actions.push({
                    id: 'id1',
                    image: 'point.png',
                    time: '100',
                    x: 100,
                    y: 200,
                    status: 'idle'
                });

                actions.push({
                    id: 'id1',
                    time: '400',
                    x: 200,
                    y: 200,
                    status: 'attacking'
                });

                actions.push({
                    id: 'id1',
                    time: '500',
                    x: 200,
                    y: 200,
                    status: 'idle'
                });

                actions.push({
                    id: 'id1',
                    time: '500',
                    x: 150,
                    y: 200,
                    status: 'hurt'
                });

                actions.push({
                    id: 'id1',
                    time: '600',
                    x: 150,
                    y: 200,
                    status: 'dead'
                });
            };

            let globalTime = 0;

            const sceneData = [
                {
                    name: 'f1',
                    image: 'point.png',
                    scale: 1,
                    keyframes: [
                        {key: 0, x: 10, y: 10, alpha: 1, color: [1, 1, 1]},
                        {key: 0.5, x: 100, y: 10, alpha: 1, color: [1, 0, 0]},
                        {key: 1, x: 10, y: 100, alpha: 0, color: [0, 0, 0]}
                    ]
                },
                {
                    name: 'f2',
                    image: 'point.png',
                    scale: 1,
                    keyframes: [
                        {key: 0, x: 10, y: 10, alpha: 1, color: [1, 1, 1]},
                        {key: 0.5, x: 10, y: 100, alpha: 1, color: [1, 0, 0]},
                        {key: 1, x: 100, y: 10, alpha: 0, color: [0, 0, 0]}
                    ]
                }
            ];

        	function loadStuff(sceneData) {
                let loader = PIXI.loader;
                sceneData.forEach(function(entry) {
                    loader = loader.add(entry.name, entry.image);
                });

                return loader;
            }

            const createSpriteFromEntry = function(entry) {
                const sprite = new PIXI.Sprite(
                    PIXI.loader.resources[entry.name].texture
                );

                sprite.scale.x = entry.scale;
                sprite.scale.y = entry.scale;
                sprite.rotation = 0.0;
                sprite.anchor.x = 0.5;
                sprite.anchor.y = 0.5;

                sprite.interactive = true;
                sprite.buttonMode = true;

                sprite.on('pointerup', function() {});

                return sprite;
            };

            const createRenderer = function() {
                const renderer = PIXI.autoDetectRenderer(
                    256, 256,
                    {antialias: false, transparent: false, resolution: 1}
                );

                renderer.view.style.border = "1px dashed black";
                renderer.backboardColor = 0x061639;
                renderer.autoResize = true;
                renderer.resize(512, 512);

                document.body.appendChild(renderer.view);

                return renderer;
            };

            const setupLoop = function(renderer, stage) {
                function gameLoop() {
                    requestAnimationFrame(gameLoop);

                    renderer.render(stage);
                }

                gameLoop();
            };

            const setupTimer = function(timelineSprites) {
                globalTime = 0;

                window.setInterval(function() {
                    globalTime += 0.01;
                    if (globalTime > 1) {
                        globalTime -= 1;
                    }

                    timelineSprites.forEach(function(timelineSprite) {
                        timelineSprite.updateTime(globalTime)
                    });

                }, 1000 / 30);
            };

            const sceneData2timelineSprites = function(sceneData) {
                const timelineSprites = [];

                sceneData.forEach(function(entry) {
                    const sprite = createSpriteFromEntry(entry);

                    // stage.addChild(sprite);

                    timelineSprites.push(new timelineSprite(sprite, entry.keyframes));
                });

                return timelineSprites;
            };

            const attachSpritesToStage = function(timelineSprites, stage) {
                timelineSprites.forEach(function(timelineSprite) {
                    stage.addChild(timelineSprite.sprite);
                });
            };

            loadStuff(sceneData)
                .load(function() {
                    const renderer = createRenderer();

                    const stage = new PIXI.Container();

                    const timelineSprites = sceneData2timelineSprites(sceneData);

                    attachSpritesToStage(timelineSprites, stage);

                    setupLoop(renderer, stage);

                    setupTimer(timelineSprites);
                });
        </script>
    </body>
</html>
